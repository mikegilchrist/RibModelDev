\documentclass{article}

\usepackage{fullpage}
\usepackage{float} %provides [H] for floats
\usepackage{datetime} %provides \currenttime command
\usepackage{xspace}
\usepackage{amssymb,amsfonts,amsmath}
\usepackage[comma,authoryear]{natbib}
\usepackage[doublespacing]{setspace}
\usepackage{tabulary} %Allows multirowed columns whose width is calculated automatically. Similar to tabularx but allows column width to vary between column types and calculated based on content of columns.  See p 253 of Mittelbach and Gossens LaTeX Companion, 2nd Ed
\usepackage[colorlinks=true,urlcolor=blue]{hyperref} %usage: \href{http://...}{link representation}
\usepackage{ulem}

\newcommand{\elongWaitTime}{\ensuremath{w}\xspace}
\newcommand{\wc}{\ensuremath{\elongWaitTime^c}\xspace}
\newcommand{\wi}{\ensuremath{\elongWaitTime_i}\xspace}
\newcommand{\wj}{\ensuremath{\elongWaitTime_j}\xspace}
\newcommand{\wk}{\ensuremath{\elongWaitTime_k}\xspace}
\newcommand{\wgi}{\ensuremath{\elongWaitTime_{g,i}}\xspace}
\newcommand{\wgj}{\ensuremath{\elongWaitTime_{g,j}}\xspace}
\newcommand{\wgc}{\ensuremath{\wc_{g}}\xspace}
\newcommand{\WaitTerm}{\ensuremath{X}\xspace} %realization of random variate
\newcommand{\Xc}{\ensuremath{\WaitTerm^c}\xspace}
\newcommand{\Xg}{\ensuremath{\WaitTerm_g}\xspace}
\newcommand{\Xgi}{\ensuremath{\WaitTerm_{g,i}}\xspace}
\newcommand{\Xgj}{\ensuremath{\WaitTerm_{g,j}}\xspace}
\newcommand{\Xgc}{\ensuremath{{\Xc}_{g}}\xspace}

\newcommand{\alphai}{\ensuremath{{\alpha_i}}\xspace}
\newcommand{\alphaj}{\ensuremath{{\alpha_j}}\xspace}
\newcommand{\alphak}{\ensuremath{{\alpha_k}}\xspace}
\newcommand{\alphac}{\ensuremath{{\alpha_c}}\xspace}
\newcommand{\alphacgprime}{\ensuremath{{\alpha_{c,g}^\prime}}\xspace}
\newcommand{\alphacvec}{\ensuremath{{\vec{\alpha}_c}}\xspace}
\newcommand{\lambdac}{\ensuremath{{\lambda_c}}\xspace}
\newcommand{\lambdacprime}{\ensuremath{{\lambda_c^\prime}}\xspace}
\newcommand{\lambdacprimevec}{\ensuremath{{\vec{\lambda}_c^\prime}}\xspace}
\newcommand{\lambdai}{\ensuremath{{\lambda_i}}\xspace}
\newcommand{\lambdaiprime}{\ensuremath{{\lambda_i^\prime}}\xspace}
\newcommand{\lambdaiprimevec}{\ensuremath{{\vec{\lambda}_i^\prime}}\xspace}
\newcommand{\lambdaj}{\ensuremath{{\lambda_j}}\xspace}
\newcommand{\lambdak}{\ensuremath{{\lambda_k}}\xspace}
\newcommand{\lambdajprime}{\ensuremath{{\lambda_j^\prime}}\xspace}
\newcommand{\lambdajprimevec}{\ensuremath{{\vec{\lambda}_j^\prime}}\xspace}



%Nonsense error terms
\newcommand{\nseWaitTime}{\ensuremath{v}\xspace}
\newcommand{\vc}{\ensuremath{\nseWaitTime^c}\xspace}
\newcommand{\vgi}{\ensuremath{\nseWaitTime_{g,i}}\xspace}
\newcommand{\vgj}{\ensuremath{\nseWaitTime_{g,j}}\xspace}
\newcommand{\vgc}{\ensuremath{\vc_{g}}\xspace}
\newcommand{\vi}{\ensuremath{\nseWaitTime_{i}}\xspace}
\newcommand{\vj}{\ensuremath{\nseWaitTime_{j}}\xspace}
\newcommand{\vk}{\ensuremath{\nseWaitTime_{k}}\xspace}
\newcommand{\betac}{\ensuremath{{\beta_c}}\xspace}
\newcommand{\muc}{\ensuremath{{\mu_c}}\xspace}
\newcommand{\sigmag}{\ensuremath{\sigma_{g}}\xspace}
\newcommand{\sigmagi}{\ensuremath{\sigma_{g}(i)}\xspace}
\newcommand{\sigmagng}{\ensuremath{\sigma_{g}(\ng)}\xspace}
\newcommand{\sigmang}{\sigmagng}
\newcommand{\Esigmagi}{\ensuremath{E\left[\sigma_{g}(i)\right]}\xspace}
\newcommand{\Esigmai}{\ensuremath{E\left[\sigma(i)\right]}\xspace}
\newcommand{\Esigmagimone}{\ensuremath{E\left[\sigma_{g}(i-1)\right]}\xspace}

\newcommand{\pgi}{\ensuremath{{p_{g,i}}}\xspace}
\newcommand{\Pgi}{\ensuremath{{P_{g,i}}}\xspace}
\newcommand{\Pgj}{\ensuremath{{P_{g,j}}}\xspace}
\newcommand{\Pgc}{\ensuremath{{P_{g}^c}}\xspace}
\newcommand{\ngc}{\ensuremath{{n_{g}^c}}\xspace}
\renewcommand{\ng}{\ensuremath{{n_{g}}}\xspace}
\newcommand{\ns}{\ensuremath{{n_s}}\xspace}
\newcommand{\mg}{\ensuremath{{m_g}}\xspace}
\newcommand{\Mg}{\ensuremath{{M_g}}\xspace}
\newcommand{\iotag}{\ensuremath{{\iota_g}}\xspace}
\newcommand{\phig}{\ensuremath{{\phi_g}}\xspace}
\newcommand{\iotae}{\ensuremath{{\iota_g^e}}\xspace}
%\newcommand{\lambdagi}{\ensuremath{{\lambda_{g,i}}}\xspace}
%\newcommand{\lambdagc}{\ensuremath{{\lambda_{g}^c}}\xspace}
\newcommand{\kappag}{\ensuremath{{\kappa_{g}}}\xspace}
\newcommand{\Ztheta}{\ensuremath{{Z}}\xspace}
\newcommand{\mRNAg}{mRNA$_g$\xspace}
\newcommand{\Yg}{\ensuremath{{Y_{g}}}\xspace}
\newcommand{\Ytotal}{\ensuremath{{Y}}\xspace}
\newcommand{\Ygi}{\ensuremath{{Y_{g,i}}}\xspace}
\newcommand{\Ygc}{\ensuremath{{Y_{g}^c}}\xspace}
\newcommand{\Kg}{\ensuremath{{K_{g}}}\xspace}
%\newcommand{\qcg}{\ensuremath{{q_{c,g}}}\xspace}
\newcommand{\Lik}{\ensuremath{\text{L}}\xspace}
\newcommand{\setG}{\ensuremath{\mathbb{G}}\xspace}
\newcommand{\setC}{\ensuremath{\mathbb{C}}\xspace}
\newcommand{\Var}{\ensuremath{\text{Var}}\xspace}
%\newcommand{\}{\ensuremath{\}\xspace}
%\newcommand{\}{\ensuremath{\}\xspace}

\newcommand{\mgvec}{\ensuremath{{\Vec{\mg}}}\xspace}
\newcommand{\Ygcvec}{\ensuremath{{\Vec{\Ygc}}}\xspace}
\newcommand{\kappagvec}{\ensuremath{{\Vec{\kappag}}}\xspace}
\newcommand{\ngcvec}{\ensuremath{{\Vec{\ngc}}}\xspace}
\newcommand{\iotagvec}{\ensuremath{{\Vec{\iotag}}}\xspace}


\begin{document}


\subsection*{History}
\begin{itemize}
\item Initial model  by mikeg on 6/10/15.
\item NSE model added by mikeg on 7/21/15.
\item 08/16/28: Fixed error for Pr(Elongation at position $j$) in Equation (\ref{eq:defEElongPrII}) by adding $\lambda_j v_{g,i}$ term.
  Additionally, applied fix to Equation (\ref{eq:defESigma}) by adding missing term to product term.
Added notes about expecting $\alphac > 0$.
\item 08/20/18
  \begin{itemize}
  \item Replace Pr(Elongation at position $j$) with Pr(Ribosome sampled is at position $j$)
  \item Added math analysis is partially documented in \texttt{rfp.math.nb} which was added to the repository.
  \item Added second order approximation of $\sigma_i$
  \end{itemize}
\item 10/22/2019
  \begin{itemize}
  \item Alex: Added continued fraction representation for approximating upper incomplete gamma function
  \end{itemize}
\item  06/30/2020
  \begin{itemize}
  \item Added equation \ref{eq:verySimpleApprox} as a simpler approximation for $\vgi/(\vgi+\wgi)$ for equation \ref{eqn:defSigmaMag}.
  \item Added note about how the integral function needs to use $\lambdac$, we can't use \lambdacprime.
  \end{itemize}
        
\item Compiled on \today \ at \ \currenttime
 \end{itemize}
\subsection*{Goal}
\label{goal}
Create sensible model for interpreting RPF data with a special interest in working with data used in \citet{PopEtAl2014}.

\section*{Pausing Time Model Definition}
\subsection*{Calculating the Likelihood of a sample}
We are interested in calculating the probability of observing a ribosome footprint (RFP) experimentally.
We assume there is a pool of RFP generated from the transcriptome, that the mRNAs in this pool are at close to steady state in terms of ribosome initiation and completion of translating a transcript.

Beginning by considering a single mRNA molecule transcribed from gene $g$, the probability a ribosome is at position $i$ of this mRNA molecule, \pgi,  is simply,
\begin{equation} \label{eq:defpgi}
\pgi  \propto \kappag \wgi
\end{equation}
where \kappag is a rate constant scales the average rate at which ribsomes intercept and initiate translation of an mRNA molecule from gene $g$, \mRNAg, under the experimental conditions used.
Formally, the initiation rate is determined by $\kappag \times r$, where  $r$ is the density of ribosomes in the cell.
However, we assume all mRNAs are equally accessible to ribosomes so, as a result, $r$ will cancel out in the following equation and, as a result, we ignore it throughout.
Additionally, \wgi is the average waiting, pausing, or dwell time of a ribosome at position $i$ of mRNA from gene $g$.  
Derivation of equation \ref{eq:defpgi} is straight forward, but can also be found \citet{GilchristAndWagner2006} equation (20) with the nonsense error rate = 0 and the ribosome recycling probability $<1$.
We can link it to \citet{PopEtAl2014} work by noting the ribsome flux $J_g$ on an individual \mRNAg is $J_g = r \kappag$.

Biologically speaking, \wgi values for the same codon are not independent.
The values of \wgi for the relevant codon likely vary within a gene as a function of mRNA structure and other factors.
To capture this variation, we will assume that for when the codon at position $i$ is of type $c$, $\wgi \sim \text{Gamma}(\alphac, \lambdac)$, where \alphac is the shape parameter, \lambdac is the rate parameter, and $E[\wgi] = \alphac/\lambdac$. %originally thought we were using the 'scale' formulation, but double checking Mathematica code indicates we are using the 'rate' formulation.
Gene specific effects could also be incorporated since  mRNA structures which interfere with efficient translation likely declines with expression level.
As a result of this assumption, we can use a Negative-Binomial (NB) distribution model to analyze the RFP data.
Regarding values of $\alphac$, no variation in waiting times between instances of the same codon would correspond to an exponential model or $\alphac = 1$.
Given that we expect heterogeneity between sites, we expect $\alphac > 1$.

Assuming independence in sampling, the total probability of a randomly selected footprint is from position $i$, $\Pgi$, is
\begin{equation} 
\label{eq:defPgi}
\Pgi = \pgi \mg/\Ztheta 
\end{equation}
where \mg is the density of \mRNAg in the cell and \Ztheta is a partition function that ensures our sampling probabilities across the transcriptome sums to 1 and is defined as,
\begin{equation}
  \label{eq:defZtheta}
  \Ztheta = \sum_g \mg \left(\sum_i \pgi\right).
\end{equation}
Equations (\ref{eq:defPgi}) and (\ref{eq:defZtheta}) indicate that our choices of time and volume units for \kappag and \mg are irrelevant and we can only estimate their values relative to one another.
This is because our choice of time units for $\kappag$ and density for $m_g$ will rescale both \pgi and, thus $\Ygi$ and $Z$.
One solution is to use the same approach in our other work and  scale time such that the average protein production rate across genes $E_g\left(\kappag \mg \sigmang\right) = 1$ where \sigmang is the probability a ribosome completes translation of the \ng codons in gene $g$.
For our current model where we ignore nonsense errors, \sigmagng = 1 and, thus, $\phig = \kappag \mg$.
An alternative would be to constrain $E_g\left(\kappag \mg\right) = 1$, i.e. independent of \sigmang.
\footnote{Prior to 06 Mar 2019 we we used $\psi$ instead of $\iota$ (see below).
  However, this use of $\psi$ was not wholly consistent with how $\psi$ was defined in SelAC where $\psi$ is the  target protein functionality production rate so we've changed our notation.
  }
  
To simplfy calculations we can derive an expected value for $\Ztheta$ as,
\begin{equation}
 \label{eq:defExpZtheta}
 E(\Ztheta) = E(\sum_g m_g \sum_i p_{g,i}) = \sum_g \kappag \mg  \sum_c n_{c,g} (\frac{\alpha_c}{\lambda_c})
\end{equation}

%We will do our best to avoid calculting \Ztheta directly and, instead, treat it as an unknown variable and attempt to sample from its posterior distribution.

Letting $\Ytotal = \sum_{g,i}\Ygi$ be the footprint sample size, where $\Ytotal \gg 1$ and $\Pgi \ll 1$, then we can approximate the probability of observing $\Ygi$ samples of a footprint in \mRNAg at position $i$ using a Poisson distribution with a sampling rate of $\Ytotal \Pgi$.
Note that deep sequencing may violate the sampling with replacement assumption of the Poisson distribution.
Given our assumption about the distribution of $\pgi$,  $\Ygi \sim \text{NB}(x = \alphac, p = \kappag \mg /(\lambdacprime + \kappag \mg)$ where $\lambdacprime = \lambdac \Ztheta/\Ytotal$.
Explicitly,
\begin{align}
  \Pr\left(\Ygi \middle| \alphac, \lambdacprime, \mg, \kappag\right) &= \frac{\Gamma\left(\alphac + \Ygi\right)}{\Gamma\left(\alphac\right) \Ygi!} 
  \left(\frac{\mg \kappag}{\lambdacprime + \mg \kappag}\right)^\Ygi \left(\frac{\lambdacprime}{\lambdacprime + \mg \kappag}\right)^\alphac \nonumber\\
  \label{eq:distYgSite}
  &=\frac{\Gamma\left(\alphac + \Ygi\right)}{\Gamma\left(\alphac\right) \Ygi!} 
  \left(\frac{\mg \kappag}{\lambdacprime + \mg \kappag}\right)^\Ygi \left(1-\frac{\mg \kappag}{\lambdacprime + \mg \kappag}\right)^\alphac
\end{align}
Note that $\mg$ and \kappag are gene $g$ and environment specific terms which can be equated to the equilibrium protein synthesis initiation rate $\iotag$ for gene $g$ under the experimental conditions, i.e.~$\iotag = \kappag \mg$.
Further, because in this model nonsense errors are ignored, all ribosomes that initiate translation also complete translation.
Thus, the initiation rate \iotag is also equal to the synthesis rate \phig.
The composite parameter \lambdacprime consists of the codon specific scale term \lambdac and  the ratio of \Ztheta to \Ytotal, two genome wide parameters.
The term \Ytotal/\Ztheta can be interpreted as the sampling efficiency, i.e.~what proportion of the RFP state space is sampled.
If $\Ytotal/\Ztheta \ll 1$, then sampling is sparse.

Given the properties of the NB \citep[p.~141]{ForbesEtAl2011} and the fact that most codons appear within a gene's ORF multiple times, the likelihood of the parameters given the total number of RFP observed derived from codons of type $c$ in gene $g$, $\Ygc = \sum_{i=\in c} \Ygi$, is,
\begin{align}
  \Lik\left(\iotag, \alphac, \lambdacprime \middle| \Ygc, \ngc\right) &= \frac{\Gamma\left(\ngc \alphac + \Ygc\right)}{\Gamma\left(\ngc \alphac\right) } 
  \left(\frac{\iotag}{\lambdacprime + \iotag}\right)^\Ygc \left(1-\frac{\iotag}{\lambdacprime + \iotag}\right)^{\ngc \alphac}\\
\label{eq:distYgCodon}&= \frac{\Gamma\left(\alphacgprime + \Ygc\right)}{\Gamma\left(\alphacgprime\right)} 
  \left(\frac{\iotag}{\lambdacprime + \iotag}\right)^\Ygc \left(1-\frac{\iotag}{\lambdacprime + \iotag}\right)^{\alphacgprime}
\end{align}
where $\ngc$ is the number of times codon $c$ is found in the ORF of gene $g$ and $\alphacgprime = \ngc \times \alphac$.
Note we dropped the $\Ygc!$ term because that will be the same for all parameter values.
The total Likelihood of the data is
\begin{equation}
  \Lik\left(\iotagvec, \alphacvec, \lambdacprimevec \middle| \Ygcvec, \ngcvec\right) = \prod_{g \in \setG} \prod_{c \in \setC}  \Lik\left(\iotag, \alphac, \lambdacprime \middle| \Ygc, \ngc\right)
\end{equation}
Note that using RFP data alone, $\kappag \times \mg = \iotag$ and $\lambdacprime = \lambdac \Ztheta/\Ytotal$ are only identifiable as joint parameters. 
(Although it seems like you should be able to calculate \Ztheta post-hoc from the state of the chain and estimates of \mg are available from other sources.)
Most standard libraries require that the $x$ parameter in a NB be discrete, which in this case it is not.
Thus to simulate \Yg values based on equations (\ref{eq:distYgSite}) or (\ref{eq:distYgCodon}), first pull $\Xgc$ from Gamma(\ngc \alphac, \lambdacprime)\footnote{recall that \lambdacprime is the 'rate' parameter.}, then pull $Y$ from Poisson($\Xgc \iotag$).
  
\citet{PopEtAl2014} provide RNA-Seq based counts of mRNA abundances, \Mg, in addition to RFP counts.
If we assume that $\Mg \sim \text{Poisson}(\Ytotal \mg)$, we can easily combine both the RFP and the mRNA counts together and estimate $\kappag$ and $\mg$ separately.
Alternatively, we could estimate the composite \kappag \mg parameter using the RPF data and then analyze the those results using the \Mg data.
An additional fact worth noting is that we are treating $Z$ as a constant for much of our calculations when, in fact, it is a random variate.
% \sout{An additional fact worth noting is that we are treating $Z$ as a constant for much of our calculations when, in fact, it is a random variate.}\marginpar{08/20/18: I don't think this is true.
%05/30/19: Update- no it is a random variate. Each position's expected wait time is a random variable and Z is a function of these times}
We should discuss this with Russ to ensure there are no issues.

%\subsection*{Simulation}
%Although our Likelihood function can be described using a Negative Binomial distribution, because $x = \alpha$ and $\a%lpha$ is not discrete, we cannot use standard NB routines to simulate our data.
%Instead we need simulate in two steps.
%First, we generate $W_c$  from $\text{Gamma}(\alphac \ngc, \lambdacprime)$ and then we generate $\Ygc$ from $\text{Poi%sson}\left(\phi_g W_c\right)$


\section*{Pausing Time with Nonsense Error Model Definition}
The flux equation, Equation (\ref{eq:defpgi}), no longer holds when nonsense errors (NSE) are possible.
Instead, following \citet{GilchristAndWagner2006}, we have the conditional probability,
\begin{equation}
\label{eq:defpgiNse}
\pgi|\wgi \propto \kappag \sigma(i-1) \frac{\wgi \vgi}{\wgi + \vgi}
\end{equation} 
Where, as before, \kappag is the translation initiation rate constant per \mRNAg, \wgi is the waiting time to elongate codon $i$, and  \wgi is 1 over the codon elongation rate ($1/c_i$ in rate based, rather than waiting time, terminology) and \vgi is the NSE 'wait' time, i.e.~1 over the NSE rate ($1/b_i$ in rate based terminology), and $\sigma(i-1)$ is the probability a ribosome that initiates translation will reach the $i$th codon.
Note that because the waiting time to a NSE, \vgi, is so much greater than the elongation waiting time \wgi we can ignore the actual variation in \vgi between codons of the same type (this is easier to understand if you consider $0 < b_i \ll 1$).
Thus while we allow \vgi to be codon specific, we treat each of these values as fixed and use \vi instead of \vgi.
Further, again because $\vi \gg \wgi$, we can approximate $\frac{\wgi \vi}{\wgi + \vi}$ as $\wgi$ based on a Taylor series expansion around $1/\vi = 0 $.
Thus,
\begin{equation}
\label{eq:defpgiNseApprox}
\pgi|\wgi \propto \kappag \sigma(i-1) \wgi
\end{equation} 
which is equivalent to the simple pausing time calculation except $\pgi$ is reduced by $\sigma(i-1)$.


The function $\sigma(i-1)$ depends on the probability of successful elongation at the $i-1$ upstream codons.
When the waiting time for elongation each position $j$ is known, then
 \begin{align}
  \label{eq:defElongPr}
\Pr(\text{Ribosome Sampled is at position $j$}) &=\frac{\vj}{\wgj + \vj} \\
\intertext{and}
   \label{eq:defSigmag}
   \sigma\left(i-1\right) = \prod_{j=1}^{i-1} \frac{\vj}{\wgj + \vj}
\end{align}

However, when fitting the model we don't wish to actually estimate individual \wgj values, but instead the parameters of the $\text{Gamma}\left(\alphaj, \lambdaj\right)$ distribution the \wgj are drawn from.
Thus we treat \wgj as a random variable whose uncertainty we integrate across to get an expected value.
Letting $f(\alpha, \lambda)$ represent the PDF of the Gamma distribution, the expectation of the codon specific elongation probability is
\begin{align}
\label{eq:defEElongPr}
E\left[\Pr(\text{Ribosome Sampled is at position $j$})\right] &= \int_0^\infty \frac{\vj}{\wgj + \vj} f\left(\wgj | \alphaj, \lambdaj\right) d\wgj\\
\label{eq:defEElongPrII}
 &= \lambdaj \vj \exp\left[\lambdaj \vj\right] E_{p = \alphaj}\left(\lambdaj \vj\right)
\end{align}
where $E_p(z)$ is the generalized exponential integral function (also referred to as Schlomilch functions \citep[][p.380]{OldhamEtAl2009} and is represented as,
\begin{equation}
  \label{eq:defGeneralizedExpoInt}
   E_p(z) = \int_1^\infty \frac{e^{-z t}}{t^p} = z^{p-1} \int_z^\infty \frac{e^{-t}}{t^p} dt = z^{p-1} \Gamma(1-p,z)
\end{equation}
where $\Gamma(1-p,z)$ is the upper incomplete gamma function.
See \href{http://dlmf.nist.gov/8.19}{http://dlmf.nist.gov/8.19} for more details.


Note that, although the complete Gamma function is discontinous at negative interger values, the upper incomplete is well defined even at negative integers so long as $z>0$.

Using this formulation, 
\begin{align}
\label{eq:defEElongPrIII}
E\left[\Pr(\text{Ribosome Sampled is at position $j$})\right] &= \exp\left[\lambdaj \vj\right] \left(\lambdaj \vj\right)^\alphaj  \Gamma(1-\alphaj, \lambdaj \vj)
\end{align}


Assuming independence in \wgi between positions means that the expected value of $\sigmag(i)$ is, 
\begin{align}
\label{eq:defESigma}
  \Esigmai &=  \exp\left[\sum_{j=1}^i \lambdaj \vj\right]  \prod_{j=1}^{i}\left(\lambdaj \vj  E_{\alphaj}\left(\lambdaj \vj\right) \right)
\end{align}
Note that these \lambdaj terms are equivalent to \lambdac (but not \lambdacprime, which is used below).
Because the calculations use nonlinear functions, we can't really use \lambdacprime as a substitute and, insteads, need to estimate $Z$.

To approximate \Esigmagi, we set $\vi = 1/(c_i b)$ where $c_i$ is a codon specific scaling factor which we assume $c_i>0$ and define $\sum_i^n c_i = 1$ such that $b = f(\vec{v})=  1/n \sum_i^n 1/\vi$ is the mean nonsense error rate.
We could, alternatively, define $\prod_i^n c_j = 1$ which would make $b = f(\vec{v}) =  \prod_i^n (1/\vi)^{1/n}$ the geometric mean of $1/vi$.
Either way, taking a first order Taylor Series approximation around $b= f(\vec{v}) =0$.
\begin{align}
\label{eq:approxESigmag}
  \Esigmai &= 1 - \sum_{j=1}^i \frac{\alphaj}{\lambdaj \vj}+ O(b^2)
\end{align}

The second order approximation around $b=0$ is,
\begin{align}
\label{eq:secondOrderApproxESigmag}
  \Esigmai &= 1 + \sum_{j=1}^i \left[\frac{\alphaj}{\lambdaj \vj} \left(-1+\sum_{k=1}^i\frac{\alphak}{\lambdak \vk} \right)+\frac{\alphaj}{\lambdaj^2 \vj^2}\right] +  O(b^3)\\
\intertext{which can be written in terms of the moments of \wi}
&= 1 + \sum_{j=1}^i \left[\frac{E\left[\wj\right]}{\vj} \left(-1+\sum_{k=1}^i\frac{E\left[\wk\right]}{ \vk} \right)+\frac{\Var\left(\wj\right)}{\vj^2}\right] +  O(b^3)
\end{align}
Note also that there should be a way to represent and, hopefully, efficiently calculatethe above equation using matrix notation.

An alternative is to approximate $\ln(\sigma_i)$ around $b=0$ and then exponentiate this approximation.
The first order approximation is,
\begin{align}
\ln(\Esigmai) &= - \sum_{j=1}^i \frac{\alphaj}{\lambdaj \vj} + O(b^2)
\end{align}
The second order approximation is,
\begin{align}
\ln(\Esigmai) &= \sum_{j=1}^i \left[-\frac{\alphaj}{\lambdaj \vj} + \frac{\alphaj}{\lambdaj^2 \vj^2} + \frac{1}{2} \left(\frac{\alphaj}{\lambdaj \vj}\right)^2\right]+ O(b^3)\\
\intertext{which can be written in terms of the moments of \wi}
\ln(\Esigmai) &= \sum_{j=1}^i \left[-\frac{E\left(\wj\right)}{\vj} + \frac{\Var\left(\wj\right)}{ \vj^2} + \frac{1}{2} \left(\frac{E\left(\wj\right)}{\vj}\right)^2\right]+ O(b^3)
\end{align}
which seems simpler to compute, but I am unsure if and when it would perform better.

Another alternative implementation is to use a continued fractions approximation for the upper incomplete gamma.
This is currently implemented in PANSEModel.cpp as PANSEModel::UpperIncompleteGammaHelper.
Following notation from \href{http://functions.wolfram.com/GammaBetaErf/Gamma2/10/}{functions.wolfram.com},

\begin{align}
\label{eq:continuedFraction}
\Gamma(a,z) &= \cfrac{z^ae^{-z}}{z + \cfrac{1 - a}{1 + \cfrac{1}{z + \cfrac{2 - a}{1 + \cfrac{2}{z+\cfrac{3 - a}{1 + \cfrac{3}{z + \cdots}}}}}}}
\end{align}

One could ignore the fact that $w$ is a RV and, instead use it's expected value, i.e.~replace $\wgj$ with $\alpha/\lambda$ and equation \ref{eqn:defSigmaMag} becomes
\begin{equation} \label{eq:verySimpleApprox}
 \sigma\left(i-1\right) \approx \prod_{j=1}^{i-1} \frac{\vj}{\alpha/\lambda + \vj}
\end{equation}
In addition, there are likely simple, rule of thumb extensions we could do that would increase the precision (or help us bound the precision).
This approximation may be useful at the start of a run as well or to find good ICs.
On further reflection, it seems to make sense to work on the $\lammbdac$ scale and then use that to calculate $Z$ and $\lambdacprime$.


Noting that the reasoning which led to equations \ref{eq:defPgi} and \ref{eq:defZtheta} for the pausing time model should still apply if we use Equation (\ref{eq:defpgiNse}) for \pgi, rather than Equation (\ref{eq:defpgi}). 
As a result,
\begin{align}
\label{eq:distYgSiteNse}
  \Pr\left(\Ygi \middle| \alphac, \lambdacprime, \iotag, \Esigmagimone\right) 
  &= \frac{\Gamma\left(\alphac + \Ygi\right)}{\Gamma\left(\alphac\right) \Ygi!} 
  \left(\frac{\iotag \Esigmagimone}{\lambdacprime + \iotag \Esigmagimone}\right)^\Ygi \left(1-\frac{\iotag\Esigmagimone}{\lambdacprime + \iotag \Esigmagimone}\right)^\alphac
\intertext{or, equivalently}
\label{eq:distYgSiteNseII}
&= \frac{\Gamma\left(\alphac + \Ygi\right)}{\Gamma\left(\alphac\right) \Ygi!}
  \left(\frac{\iotag \Esigmagimone}{\lambdacprime + \iotag \Esigmagimone}\right)^\Ygi \left(\frac{\lambdacprime}{\lambdacprime + \iotag \Esigmagimone}\right)^\alphac
\end{align}
where \ng is the number of amino acids encoded in gene $g$, i.e.~$\ng \ \sum_c \ngc$.
As before, $\kappag \times \mg = \iotag$ and $\lambdacprime = \lambdac \Ztheta/\Ytotal$.
Note also that $\Ygi!$ can be dropped from any Likelihood calculations and that the \pgi terms used to calculate \Ztheta include $\sigma(i-1)$ terms.
Further, note that $Z$ implicitly has the average value of $\iotag$ in it and, so our choice of scale for $\iotag$ will, in turn, scale, $Z$.
Thus, in this model we have both $\lambdac$ and $\lambdacprime$ and, as a result, we have an additional, genome wide parameter to estimate $U = \Ztheta/\Ytotal$.

For completeness, we  define $\phig$ as the target production rate of the functionality produced by a complete, error free protein, i.e. $\phig = \iotag \sigmagng$.
(For completeness, we note that in SelON we measure functionality production rate which is $\phig \times B$ where $B$ is the functionality of a complete error free protein as encoded relative to the optimal sequence.
Since we don't try to infer the optimal sequence here, $\psi$ is irrelevant.)
Thus, in the absence of translation errors, $\phig$ is equal to the total synthesis rate protein $g$, $\iotag$.
In contrast, in the presence of translation errors, $\iotag > \phig$ since the translation initiation rate must be elevated to compensate for the reduction in protein functionality due to translation errors.
Furthermore, while the NSE model requires the likelihood for each position be calculated separately, the underlying terms for $\Esigmagimone$ need only be calculated once per parameter evaluation since it is only how these terms are combined that varies between codons at different positions.

%%INCOMPLETE ANALYSIS
%If we have limited sampling such that $Z \gg Y$, then it would follow that $\lambdaprime \gg \iotag \Esigmagimone$ and we'd get,
%\begin{align}
%\label{eq:distYgSiteNseLimitedSampling}
%  \Pr\left(\Ygi \middle| \alphac, \lambdacprime, \iotag, \Esigmagimone\right)
%&= \frac{\Gamma\left(\alphac + \Ygi\right)}{\Gamma\left(\alphac\right) \Ygi!}
%  \left(\frac{\iotag \Esigmagimone}{\lambdacprime + \iotag \Esigmagimone}\right)^\Ygi \left(\frac{\lambdacprime}{\lambdacprime + \iotag \Esigmagimone}\right)^\alphac\\
%& \approx 


\subsection*{Simulation}
Unlike with the Pausing Time Model, we cannot aggregate codon specific RPF counts within a gene.
Instead we have to simulate each position and as before we simulate in two steps.
First, we generate $\Xgi$  from $\text{Gamma}(\alphac, \lambdacprime)$ and then we generate $\Ygi$ from $\text{Poisson}\left(\iotag \, \sigmag(i-1)\, \Xgi\right)$.
Note we are using $\sigmagi$ as defined in Eq.~(\ref{eq:defSigmag}) and not $\Esigmagi$, because when simulating data, $\wgi$ is known and, as a result, integration is unnecessary.
Note that $\iotag$ values are scaled by the footprinting sequencing effort.
Thus, we may find that you need scale all of your $\iotag$ values up or down by a constant term such that the expected number of footprints is on par with the number observed for a given set of genes.


\section*{Parameter Definitions}
\label{paramDefs}
\setlength\tymin{30pt}  %minimum column width
%\setlength\tymax{200pt}  %maximum column width
\begin{table}[H]
%  \begin{tabulary}{\textwidth}{|>{$}C<{$}|L|>{$}C<{$}|} %>{$}C<{$}| should type set the column in math mode. Use \text{} to switch to text mode.
  \begin{tabulary}{\textwidth}{|C|L|C|} 
       \hline
       & Definition & {Units}\\ \hline \hline 
    \wgi & Ribosome waiting/pausing/dwell time at codon position $i$ in gene $g$ & 1/t\\
    \alphac, \lambdac& Shape and rate parameter for distribution of waiting times for codon $c$ . The rate parameter is inversely related to average wait time, i.e.~for codon $c$ $E[\wgi] = \alphac/\lambdac$  & - \\
    \mg & Density of mRNA transcripts for gene $g$ in cytosol.& 1/{Vol}\\  
    \Mg & Observed mRNA counts from RNA-Seq data.             & 1/{Vol}\\  
    \kappag & Rate constant determining ribosome initiation rate per mRNA.  Function of diffusion of ribosomes, mRNA, and other factors. & $\frac{1}{\text{rib. mRNA Vol} t}$\\
    \phig & Target protein functionality production rate under a given set of conditions. 
            Equal to $\mg \kappag \sigmagng$ which is initiation rate discounted by the expected functionality of a protein.& 1/t\\
    \iotag &  Rate of initiation of protein synthesis under a given set of conditions. 
             Equal to $\mg \kappag = \phig/\sigmagng$ and, thus, is always greater than or equal to $\phig$. & 1/t\\ 
    \sigmagi & Probability ribosome reaches and successfully translate codon $i$. & \\
    \Esigmagi& Expectation of \sigmagi used when fitting model to data. & \\

    \pgi & Probability a ribosome is found at position $i$ on an mRNA transcript from gene $g$ when translation initiation and completion of mRNA is at steady state. &\\%$\pgi \prop \kappag \wgi$ & \\
    \Pgi & Probability of observing a footprint for position $i$ of mRNA from gene $g$.& \\%$\Pgi = \left(\pgi \mg\right)/\Ztheta$.& \\
    \Pgc & Probability of observing a footprint for codon $c$ of mRNA from gene $g$. &\\%Generally, $\Pgc = \sum_{i \in c} \Pgi$. Assuming constant elongation rates for a codon type within a transcript, i.e.$\wgi = \wgj = \wgc | \{i,j\} \in c$ gives, $\Pgc = \Pgi \ngc$.& \\
    \Ztheta& Partition function which scales the codon footprint sampling probabilities \Pgi summed across $i$ and $g$ equals 1. &\\
    \ngc & Number of codons type $c$ in mRNA of gene $g$. &  \\
    \Ygi & Number of RFP observed for position $i$ in gene $g$ &\\
    \Ygc & Number of RFP observed for codon $c$ in gene $g$ &\\
    \Ytotal & Totalnumber of RFP in dataset.&\\
    \lambdacprime& Composite parameter equal to $\lambdac Z/\Ytotal$ &\\
    $\pi_j$  & Prior probability for parameter $j$. & \\ \hline
  \end{tabulary}
   \caption{Table of model parameters}
  \label{tab:modelParam}
\end{table}


\bibliographystyle{abbrvnat}
\bibliography{/home/mikeg/BiBTeX/bibliography.full}

\end{document}


%    \wgc & Average ribosome waiting time at codon of type $c$ in gene $g$.  
%    %Note if we assume that elongation rate is the same across codons of type $c$ within a gene, then $\wgc = \wgi \forall i \in c$.  
%    & 1/t \\
%    \wc & Average ribosome waiting time of codon $c$ across all genes.  Assume $\wgi \sim\text{Gamma}(\alphac, \lambdac)$ so that counts will follow Negative Binomial distribution. & 1/t\\
%    & Shape parameter for distribution of waiting times for codon $c$ where $E[\wc] = \alphac/ \lambdac$ & -  \\
%    r & Density of ribosomes within a cell's cytosol.  Assuming well mixed system and diffusion limited interactions between ribosomes and mRNAs & \small $\frac{\text{rib.}}{\text{Vol}}$\\ 
    %That is,  $\Ztheta = \sum_g \kappag \mg \left(\sum_i \pgi\right) $. & ? \\
    %\lambdagi & Poisson rate for observing footprint for codon at position $i$ of gene $g$ where $\lambdagi = \Ytotal \Pgi$.& \\  
    %\lambdagc & Poisson rate for observing footprint for codon of type $c$ of gene $g$. $\lambdagc = \Ytotal \sum_{i\in c} \Pgi = \Ytotal \ngc \lambdagc$ if $\wgi = \wgj = \wgc$.  & \\    %If $\wgc = \wgi = \wgj | \{i,j\} \in c$ and $\wgc \sim \text{Gamma}(\alphac, \lambdac)$, then & \\
